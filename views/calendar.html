<!doctype html>
<html lang="en">

<head>
    <title>Calendario | Poodle</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous">
    </script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">

    <link href="https://fonts.googleapis.com/css?family=Work+Sans:300,400,500,600,700" rel="stylesheet">
    <script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/js/bootstrap-datepicker.min.js"></script>
    <script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
    <link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>

    <style>
      #ftco-navbar {
          position: fixed;
          z-index: 2;
          width: 100%;
      }
      body {
          color: #566787;
          background: #f5f5f5;
          font-family: 'Work Sans', Arial, sans-serif;
          font-size: 13px;
      }

      .calendar {
        width: 70%;
        max-width: 750px;
        margin: 10px auto 0;
      }

      .calendar__month {
        font-size: 20px;
        font-weight: 800;
        padding: 10px 0;
        width: 100%;
        position: relative;
      }

      .cal-month__previous,
      .cal-month__next {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        width: 30px;
        height: 30px;
        text-align: center;
        
        &:hover {
          background-color: #42A5F5;
          box-shadow: 0 5px 5px -5px rgba(0,0,0,0.75);
          border-radius: 50%;
          font-weight: 800;
          color: #111;
        }
      }

      .cal-month__next {
        right: 0;
      }

      .cal-month__current {
        text-align: center;
        color: black;
      }

      .cal-head__day,
      .cal-body__day {
        display: inline-block;
        width: 14.2857%;
        height: 80px;
        float: left;
        text-align: center;
      }

      .cal-body__week,
      .calendar__head {
        display: block;
        width: 100%;
      }

      .calendar__head {
        line-height: 50px;
        position: relative;
        
        &:after {
          content: ' ';
          position: absolute;
          bottom: 0;
          left: 0;
          right: 0;
          height: 1px;
          background-color: #90CAF9;
        }
      }

      .cal-body__day {
        color: lightgray;
        height: 80px;
        text-align: left;
        padding: 2px;
        cursor: pointer;
      }

      .cal-day__month--current {
        color: black;
      }

      .cal-day__day--today {
        font-weight: 800;
        color: #2196f3;
      }

      .cal-day__day--selected {
        background-color: #2196f3;
        box-shadow: 0 5px 10px -5px rgba(0, 0, 0, .75);
        color: #111;
      }
    </style>
</head>

<body>
   <!--Navigation bar-->
   <nav class="navbar navbar-expand-lg navbar-dark ftco_navbar bg-dark" id="ftco-navbar">
      <div class="container">
          <a class="navbar-brand" href="calendar.html" style="font-weight: bold;">Poodle</a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#ftco-nav"
              aria-controls="ftco-nav" aria-expanded="false" aria-label="Toggle navigation">
              <span class="oi oi-menu"></span> Menu
          </button>

          <div class="collapse navbar-collapse" id="ftco-nav">
              <ul class="navbar-nav ml-auto">
                  <li class="nav-item cta"><a href="create-meeting.html" class="nav-link"><span>Crear</span></a></li>
                  <li class="nav-item cta"><a href="my-meetings.html" class="nav-link"><span>Mis Meetings</span></a></li>
                  <li class="nav-item cta"><a href="user.html" class="nav-link"><span>Mi perfil</span></a></li>
                  <li class="nav-item cta dropdown">
                      <a class="nav-link" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown"
                          aria-haspopup="true" aria-expanded="false">
                          <span>Feedback</span>
                      </a>
                      <div class="dropdown-menu  dropdown-menu-right"
                          style="width:400px;height: auto;max-height: 400px;overflow-x: hidden;padding:0px;"
                          aria-labelledby="dropdownMenuLink">
                          <a class="dropdown-item" href="#" style="padding:15px">
                              <i class="fas fa-list-alt"></i>
                              Revisa tus meeting de hoy!
                          </a>
                          <hr style="margin:0px">
                          <a class="dropdown-item" href="#" style="padding:15px">
                              <i class="fas fa-hourglass"></i>
                              Cambió la hora de <b>Junta scrum KALI</b>
                          </a>
                          <hr style="margin:0px">
                          <a class="dropdown-item" href="#" style="padding:15px">
                              <i class="fas fa-calendar"></i>
                              Cambió la fecha de <b>Junta scrum KALI</b>
                          </a>
                          <hr style="margin:0px">
                          <a class="dropdown-item" href="#" style="padding:15px">
                              <i class="fas fa-map-marker-alt"></i>
                              Cambió el lugar de <b>Junta scrum KALI</b>
                          </a>
                          <hr style="margin:0px">
                          <a class="dropdown-item" href="#" style="padding:15px">
                              <i class="far fa-calendar-plus"></i>
                              Se eligió un horario de <b>Junta scrum KALI</b>
                          </a>
                          <hr style="margin:0px">
                          <a class="dropdown-item" href="#" style="padding:15px">
                              <i class="fas fa-hourglass"></i>
                              Cambió la hora de <b>Preparación de Kali</b>
                          </a>
                          <hr style="margin:0px">
                          <a class="dropdown-item" href="#" style="padding:15px">
                              <i class="fas fa-calendar"></i>
                              Cambió la fecha de <b>Preparación de Kali</b>
                          </a>
                          <hr style="margin:0px">
                          <a class="dropdown-item" href="#" style="padding:15px">
                              <i class="fas fa-map-marker-alt"></i>
                              Cambió el lugar de <b>Preparación de Kali</b>
                          </a>
                          <hr style="margin:0px">
                          <a class="dropdown-item" href="#" style="padding:15px">
                              <i class="far fa-calendar-plus"></i>
                              Se eligió un horario de <b>Preparación de Kali</b>
                          </a>
                          <hr style="margin:0px">
                      </div>
                  </li>
                  <li class="nav-item cta"><a href="login.html" class="nav-link"><span>Salir</span></a></li>
              </ul>
          </div>
      </div>
  </nav>
  <!----------------->

    <div class="container" style="padding-top: 80px;">
        <div>
          <input type="radio" name="type" value="month" checked="checked"> Mes
          <input type="radio" name="type" value="week"> Semana<br>
        </div>
        <div class="calendar" id="calendar-week" style="display:none">
            <div class="calendar__month">
                <div class="cal-month__previous"><</div>
                <div class="cal-month__current"></div>
                <div class="cal-month__next">></div>
              </div>
              <div class="calendar__head">
                <div class="cal-head__day"></div>
                <div class="cal-head__day"></div>
                <div class="cal-head__day"></div>
                <div class="cal-head__day"></div>
                <div class="cal-head__day"></div>
                <div class="cal-head__day"></div>
                <div class="cal-head__day"></div>
              </div>
              <div class="calendar__body">
                  <div class="cal-body__week">
                    <div class="cal-body__day"></div>
                    <div class="cal-body__day"></div>
                    <div class="cal-body__day"></div>
                    <div class="cal-body__day"></div>
                    <div class="cal-body__day"></div>
                    <div class="cal-body__day"></div>
                    <div class="cal-body__day"></div>
                  </div>
              </div>
            </div>
        </div>
        <div class="calendar" id="calendar-month">
            <div class="calendar__month">
              <div class="cal-month__previous"><</div>
              <div class="cal-month__current"></div>
              <div class="cal-month__next">></div>
            </div>
            <div class="calendar__head">
              <div class="cal-head__day"></div>
              <div class="cal-head__day"></div>
              <div class="cal-head__day"></div>
              <div class="cal-head__day"></div>
              <div class="cal-head__day"></div>
              <div class="cal-head__day"></div>
              <div class="cal-head__day"></div>
            </div>
            <div class="calendar__body">
              <div class="cal-body__week">
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
              </div>
              <div class="cal-body__week">
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
              </div>
              <div class="cal-body__week">
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
              </div>
              <div class="cal-body__week">
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
              </div>
              <div class="cal-body__week">
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
              </div>
              <div class="cal-body__week">
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
                <div class="cal-body__day"></div>
              </div>
            </div>
          </div>              
        </div>
        <div id="day-details" style="display: none;">

        </div>
    </div>
    <div class="modal fade" id="meetingModal" role="dialog">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title"></h4>
          </div>
          <div class="modal-body" id="modal-body">
              <div id="beginMeetings" ></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
        
      </div>
    </div>
    
    <!-- Optional JavaScript -->
    <script src="../scripts/meetings.js"></script>
    <script src="../node_modules/moment/moment.js"></script>
    <script>
        var radios = document.querySelectorAll('input[type=radio][name="type"]')
        var sectionMonth = document.getElementById("calendar-month")
        var sectionWeek = document.getElementById("calendar-week")

        var monthMeetings = []

        function changeHandler(event) {
          if ( this.value === 'month' ) {
            sectionMonth.setAttribute("style","display:block")
            sectionWeek.setAttribute("style","display:none")
          } else if ( this.value === 'week' ) {
            sectionMonth.setAttribute("style","display:none")
            sectionWeek.setAttribute("style","display:block")
          }  
        }

        Array.prototype.forEach.call(radios, function(radio) {
          radio.addEventListener('change', changeHandler);
        });

        class Calendar {
            constructor (id) {
                this.monthDiv = document.getElementById(id).querySelector('.cal-month__current')
                this.headDivs = document.getElementById(id).querySelectorAll('.cal-head__day')
                this.bodyDivs = document.getElementById(id).querySelectorAll('.cal-body__day')
                this.nextDiv = document.getElementById(id).querySelector('.cal-month__next')
                this.prevDiv = document.getElementById(id).querySelector('.cal-month__previous')
            }
            
            init () {
                moment.locale(window.navigator.userLanguage || window.navigator.language) 
                
                this.month = moment()
                this.today = this.selected = this.month.clone()
                this.weekDays = ["lun.", "mar.", "mié.", "jue.", "vie.", "sáb.", "dom."]
                
                this.headDivs.forEach((day, index) => {
                day.innerText = this.weekDays[index]
                })
                
                this.nextDiv.addEventListener('click', _ => { this.addMonth() })
                this.prevDiv.addEventListener('click', _ => { this.removeMonth() })
                
                this.bodyDivs.forEach(day => {
                day.addEventListener('click', e => {
                    let dayToShow = e.target.attributes['value']['value']
                    console.log(monthMeetings[dayToShow-1])
                    drawDetailTable(monthMeetings[dayToShow-1])
                    // draw table with day e.target.attributes['value']['value']
                    const date = +e.target.attributes['value']['value'] < 10 ? 
                      `0${e.target.attributes['value']['value']}` : e.target.attributes['value']['value']

                    if (e.target.classList.contains('cal-day__month--next')) {
                    this.selected = moment(`${this.month.add(1, 'month').format('YYYY-MM')}-${date}`)
                    } else if (e.target.classList.contains('cal-day__month--previous')) {
                    this.selected = moment(`${this.month.subtract(1, 'month').format('YYYY-MM')}-${date}`)
                    } else {
                    this.selected = moment(`${this.month.format('YYYY-MM')}-${date}`)
                    }
                    
                    this.nextDiv = document.getElementById("day-details").setAttribute('style', 'display:none;')
                    this.update()
                    // add day details
                })
                })
                
                this.update()
            }
            
            update () {
                this.calendarDays = {
                  first: this.month.clone().startOf('month').startOf('week').date(),
                  last: this.month.clone().endOf('month').date()
                }
                
                this.monthDays = {
                  lastPrevious: this.month.clone().subtract(1,'months').endOf('month').date(),
                  lastCurrent: this.month.clone().endOf('month').date()
                }
                

                this.monthString = this.month.clone().format('MMMM YYYY')
                let xhr = new XMLHttpRequest()
                xhr.open('GET','http://localhost:3000/api/meetings/month/'+
                                  this.month.clone().format('YYYY')+'-'
                                  +this.month.clone().format('MM')+'/'+
                                  JSON.parse(sessionStorage.getItem("user")).email)
                xhr.setRequestHeader('Authorization',sessionStorage.getItem("token"))
                xhr.setRequestHeader('Content-type','application/json')
                xhr.send()
                xhr.onload = () => {
                    if(xhr.status != 200){
                        alert(xhr.status+ ': '+ xhr.statusText + "/n Un error ha ocurrido, por favor inténtelo después.")
                    }else{
                      let resultJsonMeetings = JSON.parse(xhr.response).results
                      resultJsonMeetings =resultJsonMeetings.map(item => {
                          let auxDate
                          let dateDay = 'Sin Definir'
                          let dateTime = 'Sin Definir'
                          if (item.date) {
                              auxDate = new Date(item.date)
                              dateDay = auxDate.getDate() + '/' + (auxDate.getMonth() + 1) + '/' + auxDate.getFullYear()
                              dateTime = auxDate.getHours() + ':' + auxDate.getMinutes()
                          }
                          item.dateString = dateDay
                          item.timeString = dateTime
                          return item
                      })
                      
                      for (let x = 0; x<32; x++) {
                        monthMeetings[x] = resultJsonMeetings.filter(function (item) {
                          if (!(item.date)) return false 
                          let auxDate = new Date(item.date)
                          console.log(auxDate.getDate())
                          return auxDate.getDate() == (x+1)
                        })
                      }

                      this.draw(resultJsonMeetings)
                    }
                }
            }
            
            addMonth () {
                this.month.add(1, 'month')
                
                this.update()
            }
            
            removeMonth () {
                this.month.subtract(1, 'month')
                
                this.update()
            }
            
            drawDay (index, day, data) {
              this.bodyDivs[index].innerHTML = '<b value="'+day+'">' + (day) + '</b>'
              data.forEach(item => {
                this.bodyDivs[index].innerHTML += '<div style="line-height: 0.9;font-size: 9px;" value="'+day+'">' + item.toUpperCase() + '</div>'
              })
              this.bodyDivs[index].setAttribute("value",day)
            }

            draw (resultJsonMeetings) {
              this.monthDiv.innerText = this.monthString
              let dateString = ''
              let index = 0

              if (this.calendarDays.first > 1) {
                for (let day = this.calendarDays.first; day <= this.monthDays.lastPrevious; index ++) {
                    //this.bodyDivs[index].innerText = day++
                    dateString = '' + day + '/' + this.month.format('MM/YYYY')
                    let existMeetingInDate = resultJsonMeetings.filter(function (item) {
                      let auxDateItem = new Date(item.date)
                      return (auxDateItem.getDate() + '/' + auxDateItem.getMonth() + '/' + auxDateItem.getFullYear()) === dateString
                    })
                    let auxData = []
                    if (existMeetingInDate) {
                      existMeetingInDate.forEach(item => {
                        auxData.push('' + item.date.getHours() + ':' + item.date.getMinutes() + item.name.substring(0,7))
                      })
                    }
                    // request para obtener datos de dicha fecha
                    this.drawDay(index, day, auxData)
                    day++
                    

                    this.cleanCssClasses(false, index)
                    this.bodyDivs[index].classList.add('cal-day__month--previous')
                } 
              }

              let isNextMonth = false
              for (let day = 1; index <= this.bodyDivs.length - 1; index ++) {
                if (day > this.monthDays.lastCurrent) {
                    day = 1
                    isNextMonth = true
                }

                this.cleanCssClasses(true, index)

                if (!isNextMonth) {
                    if (day === this.today.date() && this.today.isSame(this.month, 'day')) {
                    this.bodyDivs[index].classList.add('cal-day__day--today') 
                    }

                    if (day === this.selected.date() && this.selected.isSame(this.month, 'month')) {
                    this.bodyDivs[index].classList.add('cal-day__day--selected') 
                    }

                    this.bodyDivs[index].classList.add('cal-day__month--current')
                    dateString = '' + day + '/' + (this.month.format('MM') ) + '/' + this.month.format('YYYY')

                    this.bodyDivs[index].setAttribute("data-toggle", "modal")
                    this.bodyDivs[index].setAttribute("data-target", "#meetingModal")
                } else {
                    this.bodyDivs[index].classList.add('cal-day__month--next')
                    if (this.month._d.getMonth() === 11) {
                      dateString = '' + day + '/' + '01' + '/' + this.month.format('YYYY')
                    } else {
                      dateString = '' + day+ '/' + (this.month._d.getMonth() + 2) + '/' + this.month.format('YYYY') 
                    }
                    
                }
                
                //this.bodyDivs[index].innerText = day++dateString = '' + day + '/' + this.month.format('MM/YYYY')
                let existMeetingInDate = resultJsonMeetings.filter(function (item) {
                  if (!(item.date)) return false 
                  let auxDateItem = new Date(item.date)
                  return (auxDateItem.getDate() + '/' + (auxDateItem.getMonth()+1) + '/' + auxDateItem.getFullYear()) === dateString
                })
                let auxData = []
                if (existMeetingInDate) {
                  existMeetingInDate.forEach(item => {
                    let auxItem = new Date(item.date)
                    auxData.push('' + auxItem.getHours() + ':' + auxItem.getMinutes() + ' - ' + item.name.substring(0,7))
                  })
                }
                // request para obtener datos de dicha fecha
                this.drawDay(index, day, auxData)
                day++
              
              }
            }
            
            cleanCssClasses (selected, index) {
                this.bodyDivs[index].classList.contains('cal-day__month--next') && 
                this.bodyDivs[index].classList.remove('cal-day__month--next')
                this.bodyDivs[index].classList.contains('cal-day__month--previous') && 
                this.bodyDivs[index].classList.remove('cal-day__month--previous')
                this.bodyDivs[index].classList.contains('cal-day__month--current') &&
                this.bodyDivs[index].classList.remove('cal-day__month--current')
                this.bodyDivs[index].classList.contains('cal-day__day--today') && 
                this.bodyDivs[index].classList.remove('cal-day__day--today')
                if (selected) {
                this.bodyDivs[index].classList.contains('cal-day__day--selected') && 
                    this.bodyDivs[index].classList.remove('cal-day__day--selected') 
                }
            }
        }

        const cal_month = new Calendar("calendar-month")
        cal_month.init()
        const cal_week = new Calendar("calendar-week")
        cal_week.init()

    </script>
</body>

</html>